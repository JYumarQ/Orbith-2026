<div class="modal fade" id="modalHistorico" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-label-primary">
                <h5 class="modal-title" id="tituloHistorico">
                    <i class="fas fa-history me-2"></i>Histórico del Trabajador
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body" id="areaImpresionHistorico">
                <div class="card bg-lighter mb-3 shadow-none border">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Nombre:</strong> <span id="histNombre">Cargando...</span>
                            </div>
                            <div class="col-md-6">
                                <strong>CI:</strong> <span id="histCI">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover">
                        <thead class="bg-label-primary">
                            <tr>
                                <th>Evento</th>
                                <th>Exp.</th>
                                <th>Unidad Organizativa</th>
                                <th>Cargo</th>
                                <th>Salario</th>
                                <th class="text-center">Fecha Inicio</th>
                                <th class="text-center">Fecha Fin</th>
                            </tr>
                        </thead>
                        <tbody id="tablaHistoricoBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cerrar
                </button>
                <button type="button" class="btn btn-primary" onclick="imprimirHistorico()">
                    <i class="fas fa-print me-1"></i> Imprimir
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function abrirModalHistorico(url) {
        // 1. Obtener o crear instancia del modal (CORREGIDO)
        var myModalEl = document.getElementById('modalHistorico');
        var modal = bootstrap.Modal.getOrCreateInstance(myModalEl);
        
        const tbody = document.getElementById('tablaHistoricoBody');
        
        // Limpiar interfaz previa
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Cargando historial...</p></td></tr>';
        document.getElementById('histNombre').innerText = 'Cargando...';
        document.getElementById('histCI').innerText = '...';
        
        modal.show();

        // 2. Pedir datos
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error("Error en la red");
                return response.json();
            })
            .then(data => {
                const historial = data.data;
                const encabezado = data.encabezado; // Aquí vienen nombre y CI separados

                // --- CORRECCIÓN "UNDEFINED" ---
                // Leemos el nombre del encabezado, NO de la tabla. Así no falla en Bajas.
                if (encabezado) {
                    document.getElementById('histNombre').innerText = encabezado.nombre_completo || '---';
                    document.getElementById('histCI').innerText = encabezado.ci || '---';
                }

                tbody.innerHTML = ''; // Limpiar spinner

                // Llenar tabla
                if (historial && historial.length > 0) {
                    historial.forEach(item => {
                        const fila = `
                            <tr>
                                <td><span class="badge bg-label-info">${item.evento}</span></td>
                                <td><strong>${item.expediente}</strong></td>
                                <td><small>${item.unidad}</small></td>
                                <td>${item.cargo}</td>
                                <td class="fw-bold">${item.salario}</td>
                                <td class="text-center">${item.fecha_inicio}</td>
                                <td class="text-center fw-bold ${item.estado_clase}">${item.fecha_fin}</td>
                            </tr>
                        `;
                        tbody.insertAdjacentHTML('beforeend', fila);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Este trabajador no tiene historial registrado.</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error: ${error.message}</td></tr>`;
            });
    }

    // --- CORRECCIÓN PANTALLA AZUL (FREEZE) ---
    // Esto asegura que al cerrar el modal, se quite el fondo oscuro
    document.getElementById('modalHistorico').addEventListener('hidden.bs.modal', function () {
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.paddingRight = '';
    });

    function imprimirHistorico() {
        const contenido = document.getElementById('areaImpresionHistorico').innerHTML;
        const titulo = document.getElementById('tituloHistorico').innerText;
        const urlBootstrap = "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css";
        
        const ventanaImpresion = window.open('', '', 'height=600,width=800');
        
        ventanaImpresion.document.write(`
            <html>
                <head>
                    <title>${titulo}</title>
                    <link rel="stylesheet" href="${urlBootstrap}">
                    <style>body { padding: 20px; }</style>
                </head>
                <body>
                    <h3 class="text-center my-4">${titulo}</h3>
                    ${contenido}
                </body>
            </html>
        `);
        ventanaImpresion.document.close();
        ventanaImpresion.focus();
        
        setTimeout(() => {
            ventanaImpresion.print();
            ventanaImpresion.close();
        }, 500);
    }
</script>