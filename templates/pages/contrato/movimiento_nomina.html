<div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
        <div class="modal-header bg-label-primary py-2">
            <h5 class="modal-title fs-5" id="movimientoLabel">
                <i class="fas fa-exchange-alt me-2"></i>Movimiento de Nómina: 
                <span class="fw-bold fs-6">No. Exp. {{ contrato_actual.no_expediente }} - {{ aspirante.nombre }} {{ aspirante.papellido }} {{ aspirante.sapellido }}</span>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body p-0">
            <form method="POST"
                class=""
                data-confirm-text="¿Confirma que desea aplicar este Movimiento de Nómina?"
                action="{% url 'movimiento_contrato' object.pk %}" 
                id="movimientoForm">
                {% csrf_token %}

                <div class="row g-0 h-100">
                    
                    <div class="col-md-6 bg-body-tertiary p-4 border-end d-flex flex-column" style="min-height: 550px;">
                        <h6 class="text-dark fw-bold mb-3 small" style="font-size: 0.8rem;">
                            <i class="fas fa-history me-1"></i> Situación Actual
                        </h6>
                        
                        <div class="d-flex flex-column flex-grow-1 gap-3">
                            
                            <div class="row g-2 flex-fill">
                                <div class="col-6">
                                    <div class="bg-white p-3 border rounded shadow-sm h-100 d-flex flex-column justify-content-center">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3"><i class="fas fa-sitemap text-primary fs-3"></i></div>
                                            <div>
                                                <small class="text-dark d-block fw-bold text-uppercase mb-1" style="font-size: 0.7rem;">Unidad Org.</small>
                                                <div class="text-secondary" style="line-height: 1.2; font-size: 0.85rem;">
                                                    {{ contrato_actual.cargo.departamento.unidad_organizativa.descripcion|default:'---' }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="bg-white p-3 border rounded shadow-sm h-100 d-flex flex-column justify-content-center">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3"><i class="fas fa-building text-info fs-3"></i></div>
                                            <div>
                                                <small class="text-dark d-block fw-bold text-uppercase mb-1" style="font-size: 0.7rem;">Departamento</small>
                                                <div class="text-secondary" style="line-height: 1.2; font-size: 0.85rem;">
                                                    {{ contrato_actual.cargo.departamento.descripcion|default:'---' }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-2 flex-fill">
                                <div class="col-6">
                                    <div class="bg-white p-3 border rounded shadow-sm h-100 d-flex flex-column justify-content-center">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3"><i class="fas fa-briefcase text-warning fs-3"></i></div>
                                            <div>
                                                <small class="text-dark d-block fw-bold text-uppercase mb-1" style="font-size: 0.7rem;">Cargo Actual</small>
                                                <div class="text-secondary" style="font-size: 0.9rem;">
                                                    {{ contrato_actual.cargo.ncargo.descripcion|default:'---' }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="bg-white p-3 border rounded shadow-sm h-100 d-flex flex-column justify-content-center">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3"><i class="fas fa-user-tag text-secondary fs-3"></i></div>
                                            <div>
                                                <small class="text-dark d-block fw-bold text-uppercase mb-1" style="font-size: 0.7rem;">Rol</small>
                                                <div class="text-secondary" style="font-size: 0.9rem;">{{ initial_rol }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-2 flex-fill">
                                <div class="col-6">
                                    <div class="bg-white p-3 border rounded shadow-sm h-100 d-flex flex-column justify-content-center">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3"><i class="fas fa-layer-group text-dark fs-3"></i></div>
                                            <div>
                                                <small class="text-dark d-block fw-bold text-uppercase mb-1" style="font-size: 0.7rem;">Grupo Escala</small>
                                                <div class="text-secondary fs-5">{{ initial_grupo|default:'-' }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="bg-white p-3 border rounded shadow-sm h-100 d-flex flex-column justify-content-center">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3"><i class="fas fa-id-badge text-dark fs-3"></i></div>
                                            <div>
                                                <small class="text-dark d-block fw-bold text-uppercase mb-1" style="font-size: 0.7rem;">Cat. Ocupacional</small>
                                                <div class="text-secondary fs-6">{{ initial_cat|default:'-' }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-2 flex-fill">
                                <div class="col-6">
                                    <div class="bg-white p-3 border rounded shadow-sm h-100 d-flex flex-column justify-content-center">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3"><i class="fas fa-code-branch text-dark fs-3"></i></div>
                                            <div>
                                                <small class="text-dark d-block fw-bold text-uppercase mb-1" style="font-size: 0.7rem;">Tridente</small>
                                                <div class="text-secondary fs-6">{{ contrato_actual.tridente|default:'-' }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="bg-white p-3 border rounded shadow-sm h-100 d-flex flex-column justify-content-center">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3"><i class="fas fa-money-check-alt text-dark fs-3"></i></div>
                                            <div>
                                                <small class="text-dark d-block fw-bold text-uppercase mb-1" style="font-size: 0.7rem;">Tipo Salario</small>
                                                <div class="text-secondary fs-6">{{ contrato_actual.get_tipo_salario_display|default:'-' }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> 

                        <div class="row mt-3"> <div class="col-12">
                                <small class="text-dark d-block fw-bold text-uppercase mb-1 ms-1" style="font-size: 0.7rem;">
                                    <i class="fas fa-wallet me-1"></i> Salario Actual
                                </small>
                                <div class="input-group input-group-lg shadow-sm">
                                    <span class="input-group-text bg-secondary text-white border-secondary py-1"><i class="fas fa-dollar-sign"></i></span>
                                    <input type="text" 
                                           class="form-control form-control-lg fs-3 fw-bold text-secondary bg-light border-secondary py-1" 
                                           value="{{ salario_actual|floatformat:2 }}" 
                                           readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 p-4 bg-white d-flex flex-column">
                        <h6 class="text-primary fw-bold mb-4 small" style="font-size: 0.8rem;">
                            <i class="fas fa-edit me-1"></i> Nueva Propuesta
                        </h6>
                        
                        <div class="flex-grow-1">
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label fw-bold text-dark text-uppercase mb-1" style="font-size: 0.7rem;">
                                        <i class="fas fa-sitemap me-1 text-secondary"></i> Unidad Organizativa
                                    </label>
                                    {{ form.unidad }} 
                                </div>
                                <div class="col-12 mt-2">
                                    <label class="form-label fw-bold text-dark text-uppercase mb-1" style="font-size: 0.7rem;">
                                        <i class="fas fa-building me-1 text-secondary"></i> Departamento
                                    </label>
                                    {{ form.departamento }} 
                                </div>
                                <div class="col-12 mt-2">
                                    <label class="form-label fw-bold text-dark text-uppercase mb-1" style="font-size: 0.7rem;">
                                        <i class="fas fa-briefcase me-1 text-secondary"></i> Cargo
                                    </label>
                                    {{ form.cargo }}
                                </div>

                                <div class="col-12"><hr class="text-muted opacity-25 my-3"></div>

                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-dark text-uppercase mb-1" style="font-size: 0.7rem;">
                                        <i class="fas fa-user-tag me-1 text-secondary"></i> Rol
                                    </label>
                                    <input type="text" class="form-control bg-light" id="mov_rol" value="{{ initial_rol }}" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-dark text-uppercase mb-1" style="font-size: 0.7rem;">
                                        <i class="fas fa-layer-group me-1 text-secondary"></i> Grupo Escala
                                    </label>
                                    <input type="text" class="form-control bg-light text-center px-1" id="mov_grupo" value="{{ initial_grupo }}" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-dark text-uppercase mb-1" style="font-size: 0.7rem;">
                                        <i class="fas fa-id-badge me-1 text-secondary"></i> Cat. Ocupacional
                                    </label>
                                    <input type="text" class="form-control bg-light" id="mov_cat" value="{{ initial_cat }}" readonly>
                                </div>

                                <div class="col-md-4 mt-2">
                                    <label class="form-label fw-bold text-dark text-uppercase mb-1" style="font-size: 0.7rem;">
                                        <i class="fas fa-money-check-alt me-1 text-secondary"></i> Tipo Salario
                                    </label>
                                    {{ form.tipo_salario }}
                                </div>
                                <div class="col-md-4 mt-2">
                                    <label class="form-label fw-bold text-dark text-uppercase mb-1" style="font-size: 0.7rem;">
                                        <i class="fas fa-code-branch me-1 text-secondary"></i> Tridente
                                    </label>
                                    {{ form.tridente }}
                                </div>
                                <div class="col-md-4 mt-2">
                                    <label class="form-label fw-bold text-dark text-uppercase mb-1" style="font-size: 0.7rem;">
                                        <i class="far fa-calendar-alt me-1 text-secondary"></i> Fecha Efectiva
                                    </label>
                                    {{ form.fecha_efectiva }}
                                    {% if form.fecha_efectiva.errors %}
                                        <div class="text-danger small">{{ form.fecha_efectiva.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div
                                    hx-get="{% url 'cargar_salarios' %}?es_movimiento=1"
                                    hx-trigger="change from:#id_cargo, change from:#id_tridente"
                                    hx-target="this"
                                    hx-swap="none"
                                    hx-include="#id_cargo, #id_tridente">
                                </div>
                            </div>
                        </div>

                        <div class="row mt-auto pt-3">
                            <div class="col-12">
                                <label class="fw-bold text-success mb-1 small text-uppercase">
                                    <i class="fas fa-wallet me-1"></i> Nuevo Salario
                                </label>
                                <div class="input-group input-group-lg shadow-sm">
                                    <span class="input-group-text bg-success text-white border-success py-1"><i class="fas fa-dollar-sign"></i></span>
                                    <input class="form-control form-control-lg fs-3 fw-bold text-success bg-white border-success py-1" 
                                           id="salarioEscala" name="salarioEscala" readonly value="{{ initial_salario_escala|floatformat:2 }}">
                                </div>
                            </div>
                            
                            <div class="d-none">
                                {# AGREGADO: El campo 'tipo' que faltaba #}
                                {{ form.tipo }}
                                
                                {{ form.fecha_alta }}
                                {{ form.no_expediente }}
                                {{ form.reg_militar }}
                                
                                {# Opcional: Agrégalo si tu modelo usa 'profesional' y es obligatorio #}
                                {{ form.profesional }} 

                                <input type="hidden" name="no_expediente" value="{{ contrato_actual.no_expediente }}">

                                <input id="tarifaHoraria" name="tarifaHoraria" value="{{ initial_tarifa_horaria }}">
                                <input id="tarifaExtras" name="tarifaExtras" value="{{ initial_tarifa_extras }}">
                            </div>
                        </div>

                    </div>
                </div> 

                <div class="modal-footer bg-body-tertiary border-top px-4 py-2">
                    <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary px-4">Confirmar Movimiento</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    (function() {
        var $form = $('#movimientoForm');
        
        if (window.htmx) htmx.process($form[0]);

        $form.on('submit', function(e) {
            e.preventDefault(); // Detener envío normal
            
            // 1. Validación Frontend
            var fecha = $form.find('[name="fecha_efectiva"]').val();
            if(!fecha) {
                Swal.fire('Atención', 'Debe seleccionar una Fecha Efectiva.', 'warning');
                return;
            }

            // 2. Pregunta de Confirmación (Reemplaza a la de base.html)
            Swal.fire({
                title: '¿Confirmar Movimiento?',
                text: "¿Desea aplicar este cambio de nómina? Esta acción generará históricos.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, aplicar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#696cff',
                cancelButtonColor: '#8592a3'
            }).then((result) => {
                if (result.isConfirmed) {
                    // 3. Si dice SÍ -> Enviamos AJAX
                    enviarDatos();
                }
            });
        });

        function enviarDatos() {
            // Mostrar estado de carga (opcional pero recomendado)
            Swal.fire({ title: 'Procesando...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });

            $.ajax({
                url: $form.attr('action'),
                type: 'POST',
                data: $form.serialize(),
                success: function(response) {
                    if (response.form_is_valid) {
                        $('#editar_empl').modal('hide');
                        Swal.fire({
                            icon: 'success', 
                            title: 'Operación Exitosa', 
                            text: response.message,
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            if(response.success_url) window.location.href = response.success_url;
                            else location.reload();
                        });
                    }
                },
                error: function(xhr) {
                    var res = xhr.responseJSON;
                    if (res && res.error_popup) {
                        // Error Crítico (500)
                        Swal.fire('Error del Sistema', res.error_popup, 'error');
                    } else if (res && res.html_form) {
                        // Error de Validación (400) - Cerramos el loading y pintamos el form
                        Swal.close(); 
                        $('#editar_empl').html(res.html_form);
                    } else {
                        Swal.fire('Error', 'Error de comunicación inesperado.', 'error');
                    }
                }
            });
        }
    })();
</script>