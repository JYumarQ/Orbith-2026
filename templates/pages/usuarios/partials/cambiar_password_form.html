<div class="modal-dialog" role="document">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="cambiarPasswordModalLabel">
        Asignar Nueva Contraseña
      </h5>
    </div>
    <div class="modal-body">
      <form
        method="POST"
        class="swal-confirm"
        data-confirm-text="¿Estás seguro de guardar esta contraseña?"
        action="{% url 'cambiar_password' pk=user.id %}"
        id="formCambiarPassword"
      >
        {% csrf_token %}

        <div class="mb-3">
          <label
            for="{{ form.new_password1.id_for_label }}"
            class="form-label"
          >
            Nueva contraseña
          </label>
          {{ form.new_password1 }}
          <div id="new-password-error" class="text-danger small d-none"></div>
          {% if form.new_password1.errors %}
            <div class="text-danger small">
              {{ form.new_password1.errors }}
            </div>
          {% endif %}
          <div id="password-strength" class="small mt-1"></div>
        </div>

        <div class="mb-3">
          <label
            for="{{ form.new_password2.id_for_label }}"
            class="form-label"
          >
            Confirmar nueva contraseña
          </label>
          {{ form.new_password2 }}
          <div id="confirm-password-error" class="text-danger small d-none"></div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            id="save-button"
            disabled
          >
            Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script type="text/javascript">
  // Comprueba requisitos: longitud mínima, mayúscula, número y carácter especial
  function evaluarContraseña(password) {
    const minLength    = password.length >= 8;
    const hasUpperCase = /[A-Z]/.test(password);
    const hasDigit     = /\d/.test(password);
//    const hasSpecial   = /[!@#$%^&*(),.?":{}|<>]/.test(password);
    return minLength && hasUpperCase && hasDigit; //&& hasSpecial;
  }

  // Mide nivel de fortaleza (opcional para mostrar indicador)
  function evaluarFortaleza(password) {
    let strength = 0;
    if (password.length >= 8) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[\W]/.test(password)) strength++;
    if (strength <= 1) return { text: "Débil", color: "red" };
    if (strength <= 3) return { text: "Media", color: "orange" };
    return { text: "Fuerte", color: "green" };
  }

  // Valida coincidencia y requisitos, muestra/oculta errores y activa botón
  function validarFormulario(pwd1, pwd2) {
    const isValid        = evaluarContraseña(pwd1);
    const matchPasswords = pwd1 === pwd2;

    // error de fortaleza (solo si ya hay texto en confirmación)
    if (pwd2 !== "") {
      if (!isValid) {
        $("#new-password-error")
          .removeClass("d-none")
          .text(
            "La contraseña debe contener al menos 8 caracteres, una mayúscula y un número."
          );
      } else {
        $("#new-password-error").addClass("d-none");
      }

      // error de coincidencia
      if (pwd1!=pwd2) {
        $("#confirm-password-error")
          .removeClass("d-none")
          .text("Las contraseñas no coinciden.");
      } else {
        $("#confirm-password-error").addClass("d-none");
      }
    }

    // activar/desactivar botón Guardar
    if (isValid && matchPasswords && pwd2 !== "") {
      $("#save-button").prop("disabled", false);
    } else {
      $("#save-button").prop("disabled", true);
    }
  }

  $(function () {
    // al escribir en cualquiera de los dos campos
    $("#id_new_password1, #id_new_password2").on("input", function () {
      const pwd1 = $("#id_new_password1").val();
      const pwd2 = $("#id_new_password2").val();

      // actualiza indicador de fortaleza
      const result = evaluarFortaleza(pwd1);
      $("#password-strength")
        .text("Fortaleza: " + result.text)
        .css("color", result.color);

      // valida siempre que cambie cualquiera de los inputs
      validarFormulario(pwd1, pwd2);
    });

    // al hacer foco en confirmación muestra error de fortaleza inmediato
    $("#id_new_password2").on("focus", function () {
      const pwd1 = $("#id_new_password1").val();
      if (pwd1 !== "" && !evaluarContraseña(pwd1)) {
        $("#new-password-error")
          .removeClass("d-none")
          .text(
            "La contraseña debe contener al menos 8 caracteres, una mayúscula y un número."
          );
      } else {
        $("#new-password-error").addClass("d-none");
      }
    });
  });
</script>
